```
shortname: 12/Prov
name: Provenance metadata
type: Standard
status: Raw
editor: Kiran Karkera <kiran.karkera@dex.sg>
```

Table of Contents
=================

   * [Table of Contents](#table-of-contents)
   * [Provenance for Ocean assets and services](#provenance-for-ocean-assets-and-services)
      * [Change Process](#change-process)
      * [Language](#language)
      * [What is provenance?](#what-is-provenance?)
         * [W3C Provenance overview](#w3c-provenance-overview)
         * [Entities](#Entities)
         * [Agents](#Agents)
         * [Activities](#Activities)
      * [Provenance for Ocean Entities and Interactions](#provenance-for-ocean-entities-and-interactions)
      * [Motivation and Use cases](#motivation-and-use-cases)
      * [OCN Prov w.r.t W3C Prov](#ocn-prov-wrt-w3c-prov)
      * [Ocean IDs](#ocean-ids)
      * [Ocean Prov entities](#ocean-prov-entities)
      * [Use case 1 : Publishing](#use-case-1--publishing)
      * [Use case 2 : Importing](#use-case-2--importing)
      * [Usecase 3: A service generating a new asset from existing assets](#usecase-3-a-service-generating-a-new-asset-from-existing-assets)
      * [FAQ](#faq)
      
# Provenance for Ocean assets and services 

This document describes 

- What is Provenance
- What is Provenance in the context of Ocean
- Definitions of formats for annotating provenance
- Examples of provenance metadata

This specification is called **PROV** henceforth.

## Change Process
This document is governed by the [2/COSS](../2/README.md) (COSS).

## Language
The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in [BCP 14](https://tools.ietf.org/html/bcp14) \[[RFC2119](https://tools.ietf.org/html/rfc2119)\] \[[RFC8174](https://tools.ietf.org/html/rfc8174)\] when, and only when, they appear in all capitals, as shown here.


## Overview 

W3C defines provenance as:

> Provenance is information about entities, activities, and people involved in producing
> a piece of data or thing, which can be used to form assessments 
> about its quality, reliability or trustworthiness. [source](https://www.w3.org/TR/prov-overview/#Abstract)

Readers may wish to refer to a longer introduction about the W3C Provenance standard [here](https://www.w3.org/TR/2013/NOTE-prov-primer-20130430/#intuitive-overview-of-prov).

In the context of Ocean, data assets could be

* Published by a person or organization
* Comprised of information about a person or set of persons (e.g. a data asset of medical study with data on subjects)
* Revised or updated by a different person or organization
* Merged by joining one or more data assets 
* Generated by a process that takes one or more data assets as inputs (e.g. training a model on 2 data assets) and produces a new data asset.

Ocean provenance records information about the Actors (e.g. people), Activities (e.g. data cleaning, model training), Entities (data assets, algorithms) and the interactions between them. 

A database of provenance metadata can help answer questions such as:

* Who was involved in creating a data asset
* When did this data asset last change
* What were the inputs to the process that generated this data asset.
* Which versions of a data asset were used to train a specific model version

### W3C Provenance overview 

Provenance can be modeled as a graph consisting nodes and connections between the nodes. The nodes in the graph are:

### Entities 

> In PROV, physical, digital, conceptual, or other kinds of thing are called entities. 
> Examples of such entities are a web page, a chart, and a spellchecker. [source](https://www.w3.org/TR/2013/NOTE-prov-primer-20130430/#entities)


### Agents

> An agent takes a role in an activity such that the agent can be assigned 
> some degree of responsibility for the activity taking place. An agent can be a person, 
> a piece of software, an inanimate object, an organization, or other entities 
> that may be ascribed responsibility. [source](https://www.w3.org/TR/2013/NOTE-prov-primer-20130430/#agents-and-responsibility)

### Activities

> Activities are how entities come into existence and how their attributes change to 
> become new entities, often making use of previously existing entities to achieve this. 
> They are dynamic aspects of the world, such as actions, processes, etc.
> For example, if the second version of document D was generated by a translation from 
> the first version of the document in another language, then this translation is an activity. [source](https://www.w3.org/TR/2013/NOTE-prov-primer-20130430/#activities-1)


![relationships between nodes](https://www.w3.org/TR/2013/NOTE-prov-primer-20130430/images/key-concepts.png)

Some of the connections/relationships between the nodes are:

* Entity-Activity interactions 
  - Activities generate new Entities  (wasGeneratedBy)
    - Example: A Data asset was generated by the publishing activity
  - Activities make use of Entities.  (used)
    - Example: A model training Activity used a training data asset Entity
  
* Agent-Activity interactions
  - Agents are associated with Activities (wasAssociatedWith)
    - Example: A user was associated with a publishing Activity
  
* Entity-Entity interactions
  - Entities can be derived from other Entities. (wasDerivedFrom)
    - Example: A cleaned data asset was derived from a raw data asset.
  
* An Activity can be started or finished at a particular time.


The rest of this document describes the format to be used for Provenance metadata in Ocean protocol.

## Provenance for Ocean Entities and Interactions 

In the Ocean context

* Data Assets and Algorithms are Entities. 
* Publishers, Consumers and Service Providers are Agents.
* Publishing and invoking services are Activities. 

Comparing a colloquial statement with the canonical Provenance definition:

| Colloquial                                          | Provenance Description                                                                                                                                                                                                  |
|-----------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| User Bob uploaded a data asset to Ocean                | (Agent) Bob was associated with a publishing activity, which generated a (Entity) data asset                                                                                                                            |
| Bob invoked a Consent operation to filter a data asset | (Agent) Bob was associated with a filtering activity, which *used* an (Entity) data asset and  generated a new (Entity) data asset. The consent service (Entity) was involved in (associated with) generating the asset |
|                                                     |                                                                                                                                                                                                                         |

## Motivation and Use cases

Provenance information can be read from three perspectives:

* Agent centered : People or organizations were involved in generating or manipulating the data assets
* Object centered : The origins of (portions of) a data asset from other data assets
* Process centered: Capturing the actions and steps taken to generate the data asset.

Use cases:

- Finding derivatives of a data asset
  -  e.g an model training algorithm (an Entity in Prov) has been involved in generating several assets (e.g. trained models). Let's assume that a data scientist found a bug in the algorithm and fixed it. Provenance metadata can help us find the data assets generated by this algorithm, which need to be updated.
  - The publisher of a data asset A1 (Entity in prov) requires that all data assets that used A1, must pay licensing fees as a percentage of their selling price. Provenance metadata can help us find all the data assets that used data asset A1.
- Reproducibility
  - According to a 2016 survey by Nature magazine, many scientific fields are facing a reproducibility [crisis](https://www.nature.com/news/1-500-scientists-lift-the-lid-on-reproducibility-1.19970), and this is particularly relevant to data science. Provenance infomation added to data pipelines can enable reproducibility of data assets generated by these pipelines.
  
  
![Provenance generated by operations](https://user-images.githubusercontent.com/89076/56648463-f9593e80-66b5-11e9-8bda-47a71cafdfa1.png)

# Definitions 

Since the Ocean asset metadata is in JSON format, the provenance section is serialized in PROV-JSON, which is a JSON representation of the PROV data model. 

Ocean provenance metadata should be compatible with W3C Prov. However, it may have additional constraints outlined below. Ocean may provide validation tools to check if the provenance spec is Ocean standards compliant.

## Ocean IDs


#### Assets

Prov metadata identifies assets with the asset ID or DID.

#### Agents 

Prov metadata identifies agents based on category:
- Service providers such as Storage service provider, with the DID
- Ocean consumers could be identified by specifying
  - Ethereum account along with **type** as ethereum account
  - If the user has a DID, s/he is encouraged to use the DID as the identifier. 

#### Activities

Activities can be categorized into two types:

- Invoke operations are activities, and they can be identified by their asset (operation) ID or DID.
- Manual activities (e.g. data cleaning) will benefit by having an ID. However, it is not mandatory for manual activities to have an ID.
 
## Ocean Prov entities

Ocean adds the following additional *prov:type* for entities, activities and agents. Note that the prefixes `op` and `prov` are namespace prefixes that correspond to namespace [IRIs](https://dvcs.w3.org/hg/rdf/raw-file/default/rdf-concepts/index.html#dfn-namespace-iri). The standard recommends that it is `common to abbreviate IRIs that start with namespace IRIs by using a namespace prefix in order to assist readability`.

* Entities:
  - op:asset : An Ocean data asset 
  - op:this: a special attribute value that refers to the Entity being published or generated. 
  
* Activities:

  - op:publish : The act of publishing a data asset
  - op:import : The act of importing a data asset which is defined in an existing data catalog. `Import` is used to distinguish from `publish` to indicate that the provenance metadata was already associated with the data asset.
  - op:invoke : The act of invoking an operation.

* Agents:

  - op:did : DID of an Ocean Agent, if available.
  - op:address: The address of the agent, which is needed to look up the asset id (TODO: where is asset id defined?)
  - op:id_type : The type of the agent id, could be `ethereum_account` or `did`  TODO:remove


## Sections 

Recall that the asset metadata is a JSON object, which is an unordered set of name/value pairs. Provenance metadata is represented as a name/value pair in the asset metadata object, where the **name** must be "provenance". 
Note that provenance information is optional. However, if the **name** provenance exists, the value against that name must be JSON object with valid provenance metadata, as described in the rest of this document.

The JSON Object representing provenance information consists of the following properties (this section is taken from the prov-json Overview)

```
{
    "entity": { // Map of entities by entities' IDs
    },
    "activity": { // Map of activities by IDs
    },
    "agent": { // Map of agents by IDs
    },
    <relationName>: { // A map of relations of type relationName by their IDs
    },
    ...
    "bundle": { // Map of named bundles by IDs
    }
}
```

Each property is itself a JSON Object. 
This DEP recommends that the provenance object must contain the following properties:

- **entity** Data asset being published
- **activity** Activity could be one of publish, import, or operation 
- **agent** Agent (the ID of the person, organization or software) that published the data asset

Additionally, the DEP recommends that the following **relations** should be declared:

- **wasGeneratedBy** relation which associates the entity with the activity that generated it
- **wasAssociatedWith** relation with links the entity with the agent that published it 
- **wasDerivedFrom** relation which associates the input entities with the generated entities


### Entity

**entity** is a JSON object consisting of name/value pairs. This object must contain references to all ocean assets involved in the activity (described in the activity section). 

- the **names** must be valid Ocean DIDs.
- the json object against each **name** must  contain the type property, where types can be one of the supported ocean asset types (e.g. asset, bundle or operation)
- the **name** `op:this` has a special meaning, indicating that it refers to the asset currently being registered, hence it refers to itself.

Example of an entity declaration:
```
{
	"entity": {
		"op:this": {
			"prov:type": {
				"$": "op:asset",
				"type": "prov:string"
			}
		},

		"op:did:op:26cb1a92e8a6b52e47e6e13d04221e9b005f70019e21c4586dad3810d46220135/abcd": {
			"prov:type": {
				"$": "op:asset",
				"type": "prov:string"
			}
		}
	}
}
```


### Activity 

This DEP supports three types of activities:

- Publishing a data asset
- Importing a data asset present in a different data catalog system, which has provenance information already associated with it.
- Registering a new asset which was created as a result of running an invoke operation.

Each activity addresses a different use case, and therefore impacts the provenance metadata.

-  Publishing
  - the "op:this" property must be present in the *entity* JSON object.
 
- Importing
  - the "op:this" property must be present in the *entity* JSON object.
  
- Invoking an operation
  - the "op:this" property must be present in the *entity* JSON object.
  - A list of entities that were consumed by this operation as inputs.
  
  
#### Properties of activity
Activities must declare

- an identifier, which must be a qualified name as defined by Prov-DM. 
- a "prov:type" property, indicating the type of the activity, as described above.
- if the "prov:type" is `operation`, it must contain `op:params` and `op:results` properties. These are the inputs to, and output from, the invoke operation.

It is recommended that activities declare
-  start and endtime properties

Example of an activity:
```
{
	"activity": {
		"op:op_asf29fj291lkd": {
			"prov:endTime": "2018-02-02T14:07:13",
			"prov:startTime": "2018-02-02T11:03:23",
			"prov:type": {
				"$": "op:operation",
				"type": "prov:string"
			},
			"op:params": {
				"to-hash": {
					"did": "op:did:op:26cb1a92e8a6b52e47e6e13d04221e9b005f70019e21c4586dad3810d46220135/abcd"
				}
			},
			"op:results": {
				"result1": "op:this"
			}
		}
	}
}
```

### Agent

The agent is the service provider responsible for running the activity. 

- If the activity is invoking an operation, the agent's DID must be declared.
- If it is a publisher, the publisher's account must be declared.
```
{
	"agent": {
		"op:did:op:26cb1a92e8a6b52e47e6e13d04221e9b005f70019e21c4586dad3810d46220135": {}
	}
}
```

### Relations

This DEP recommends that the following attributes should be used. Other attributes defined in the prov standard (e.g. usedBy or wasAttributedTo) can be used as well.
Each attribute object must include an identifier (e.g. "_:wbg4_", which includes an optional prefix as well as a local part)

* Generation attribute (The Entity that was generated by the activity). It must specify the attributes

- `prov:entity`: the identifier of the entity that was generated, identified by `op:this`
- `prov:activity` : the identifier of the activity (e.g. invoking an operation) that generated the entity

Example:
```
{
  "wasGeneratedBy": {
    "_:wGB4": {
      "prov:entity": "op:this",
      "prov:activity": "op:op_asf29fj291lkd"
    }
  }
```

* Association attribute (the agent involved in the activity). It must specify
- `prov:agent`: the identifier of the agent
-  `prov:activity` : the identifier of the activity

Example:
```
"wasAssociatedWith": {
    "_:wAW4": {
      "prov:agent": "op:op_abvfwi89sjek",
      "prov:activity": "op:op_asf29fj291lkd"
    }
  }
```

* Derivedby attribute (The source Entity from which the new Entity was derived). This section must specify:

- `prov:generatedEntity` : the entity that was generated. Usually `op:this`.
- `prov:usedEntity`: the identifier of the entity that was used as an input to the activity. If multiple entities were consumed, each one must be defined as a separate property. 

Example:
```
"wasDerivedFrom": {
    "_:wDF2": {
      "prov:generatedEntity": "op:this",
      "prov:usedEntity": "op:c98edc33b01c32b2d655fe0c5689fe6e5c0f71193796d3d0be035c58b1c6dfde"
    }
    }
```

## Use cases

### Usecase 1: Publishing use case 

It is recommended that the publisher includes prov metadata when an asset is published for the first time on Ocean.

Example section:

* Prefixes used

```
"prefix": {
    "xsd": "http://www.w3.org/2001/XMLSchema#",
    "prov": "http://www.w3.org/ns/prov#",
    "op": "http://www.oceanprotocol.com/prov",
  }

```

* The Agent involved, could be a prov:Person, prov:Organisation or prov:SoftwareAgent
 ```
"agent": {
    "op:c98edc33b01c32b2d655fe0c5689fe6e5c0f71193796d3d0be035c58b1c6dfde": {
      "prov:type": {
                "$": "ocn:ethereum-account",
                "type": "prov:string"
      }
    }
  }
```

* The Activity (publish) 
 
```
  "activity": {
    "op:op_asf29fj291lkd": {
      "prov:type": {
				"$": "op:publish",
				"type": "prov:string"
		}
    }
  }
```

* The Entity (data asset) that was published

- An "prov:type" attribute that could take values `op:asset` or `op:operation`.
  
Example:
```
"entity": {
    "op:this": {
    "prov:type": {
				"$": "op:asset",
				"type": "prov:string"
			}
    }
  }
```

* Generation attribute 
  - IDs for the Entity generated by the publishing activity 
  
```
{
  "wasGeneratedBy": {
    "_:wGB4": {
      "prov:entity": "op:this",
      "prov:activity": "op:op_asf29fj291lkd"
    }
  }
```

### Usecase 2: Importing data asset usecase

When a user imports a data asset, the suggested provenance is similar to the publishing use case, with the exception of:

- the _type_ of the activity should be `op:import`.

### Usecase 3: A service generating a new asset from existing assets

Ocean Invoke operations such as data cleaning, model training and others, generate a new data asset. This process could have the following characteristics

- It could use one or more data assets or algorithms as input  (e.g a trained model would need an algorithm, and a training set as inputs)
- It could generate one of more data assets or algorithms as output (e.g. a trained model, and predictions from the model, could be the output of the activity)


The provenance graph must specify the following nodes:

- Agents:
  - The Agent (software implementation that runs the operation) that invoked the service 
  - The consumer that invoked the operation

- Entities:
  - A list of of inputs to this activity. It could contains a list of data assets and algorithms.
  - a list of outputs generated by this activity, referred to as "this" identifier. If multiple outputs are generated, each one is registered as a separate asset. 
  
- Activity: 
  - The operation that was invoked (e.g model training)
  
It must specify the following relations:

- Generation (wasGeneratedBy)
- Derivation (wasDerivedBy):
  - The source Entity from which the new Entity was derived
- Association (wasAssociatedWith)
  - the agent(s) associated with the activity.
  
Example: 

* The agent involved. In this case, the service consumer, and the data cleaning service implementation.
```
"agent": {
"op:503a7b959f91ac691a0881ee724635427ea5f3862aa105040e30a0fee50cc1a00": {
      "prov:type": {
           "$": "op:ethereum-account",
           "type": "prov:string"
      }
    },
    "op:did:op:26cb1a92e8a6b52e47e6e13d04221e9b005f70019e21c4586dad3810d46220135": {
      "prov:type": {
           "$": "prov:SoftwareAgent",
           "type": "prov:QUALIFIED_NAME"
      }
    }
  }
```

* The activity (data cleaning) 

```
  "activity": {
    "op:op_asf29fj291lkd": {
      "prov:endTime": "2018-02-02T14:07:13", 
      "prov:startTime": "2018-02-02T11:03:23", 
      "prov:type": {
				"$": "op:operation",
				"type": "prov:string"
			},
      "op:params": {
				"to-hash": {
					"did": "op:did:op:26cb1a92e8a6b52e47e6e13d04221e9b005f70019e21c4586dad3810d46220135/abcd"
				}
			},
			"op:results": {
				"hashval": "op:this"
			}
    }
  }
```

* The Entity (a single data asset) that was generated

Example:
```
"entity": {
    "op:this": {
      "prov:value": {
        "$": "op:asset",
        "type": "xsd:string"
      }
    }
  }
```

* Generation attribute (The Entity that was generated by the activity)
```
{
  "wasGeneratedBy": {
    "_:wGB4": {
      "prov:entity": "op:this",
      "prov:activity": "op:op_asf29fj291lkd"
    }
  }
```

* Association attribute (the agents involved in the activity)
```
"wasAssociatedWith": {
    "_:wAW4": {
      "prov:agent": "op:503a7b959f91ac691a0881ee724635427ea5f3862aa105040e30a0fee50cc1a00",
      "prov:activity": "op:op_asf29fj291lkd"
    },
    "_:wAW5": {
      "prov:agent": "op:did:op:26cb1a92e8a6b52e47e6e13d04221e9b005f70019e21c4586dad3810d46220135",
      "prov:activity": "op:op_asf29fj291lkd"
    }
  }
```

* Derivedby attribute
  - The source Entity from which the new Entity was derived
```
"wasDerivedFrom": {
    "_:wDF2": {
      "prov:generatedEntity": "op:this",
      "prov:usedEntity": "op:c98edc33b01c32b2d655fe0c5689fe6e5c0f71193796d3d0be035c58b1c6dfde"
    }
    }
```


## FAQ


2. Multiple entities/assets can be generated while generating a new asset. If "implicit"/self asset ids are assumed, then we cannot pinpoint the asset referenced. 
 - Each asset should have its own asset metadata, multiple assets should not share the same metadata.
 
4. Which entity generates the provenance metadata?
 - When a operation generates an asset, the service must create valid provenance metadata.
 - When a user creates a derived data asset (e.g by cleaning a raw data asset), then they may manually add provenance metadata.
 
## License

Copyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/)
 
## TODO

```
"agent": {
"op:did:op:26cb1a92e8a6b52e47e6e13d04221e9b005f70019e21c4586dad3810d46220135/503a7b959f91ac691a0881ee724635427ea5f3862aa105040e30a0fee50cc1a00": {
      "prov:label": "Hospital data administrator",
      "prov:type": {
           "$": "prov:Person",
           "type": "prov:QUALIFIED_NAME"
      }
    }
  }
```

```
{
	"prefix": {
		"xsd": "http://www.w3.org/2001/XMLSchema#",
		"prov": "http://www.w3.org/ns/prov#",
		"op": "http://www.oceanprotocol.com/prov"
	},

	"agent": {
		"op:did:op:26cb1a92e8a6b52e47e6e13d04221e9b005f70019e21c4586dad3810d46220135": {}
	},
	"activity": {
		"op:op_asf29fj291lkd": {
			"prov:endTime": "2018-02-02T14:07:13",
			"prov:startTime": "2018-02-02T11:03:23",
			"prov:type": "op:operation",
			"op:params": {
				"to-hash": {
					"did": "op:did:op:26cb1a92e8a6b52e47e6e13d04221e9b005f70019e21c4586dad3810d46220135/abcd"
				}
			},
			"op:results": {
				"result1": "op:this"
			}
		}
	},
	"entity": {
		"op:this": {
			"prov:type": {
				"$": "op:asset",
				"type": "xsd:QName"
			}
		},

		"op:did:op:26cb1a92e8a6b52e47e6e13d04221e9b005f70019e21c4586dad3810d46220135/abcd": {
			"prov:type": {
				"$": "op:asset",
				"type": "xsd:QName"
			}
		}
	},

	"wasGeneratedBy": {
		"_:wGB4": {
			"prov:entity": "op:this",
			"prov:activity": "op:op_asf29fj291lkd"
		}
	},
	"wasAssociatedWith": {
		"_:wAW4": {
			"prov:agent": "op:did:op:26cb1a92e8a6b52e47e6e13d04221e9b005f70019e21c4586dad3810d46220135",
			"prov:activity": "op:op_asf29fj291lkd"
		}

	},

	"used": {
		"_:u1": {
			"prov:entity": "op:did:op:26cb1a92e8a6b52e47e6e13d04221e9b005f70019e21c4586dad3810d46220135/abcd",
			"prov:activity": "op:op_asf29fj291lkd"
		}
	},
	"wasDerivedFrom": {
		"_:wDF2": {
			"prov:generatedEntity": "op:this",
			"prov:usedEntity": "op:c98edc33b01c32b2d655fe0c5689fe6e5c0f71193796d3d0be035c58b1c6dfde"
		}
	}
}

```
