```
shortname: 12/Prov
name: Provenance metadata
type: Standard
status: Raw
editor: Kiran Karkera <kiran.karkera@dex.sg>
```

Table of Contents
=================

   * [Table of Contents](#table-of-contents)
   * [Overview](#overview)
       * [W3C Provenance](#w3c-provenance)
         * [Entities](#Entities)
         * [Agents](#Agents)
         * [Activities](#Activities)
      * [Provenance for Entities and Interactions](#provenance-for-entities-and-interactions)
      * [Motivation and Use cases](#motivation-and-use-cases)
   * [Definitions](#definitions)
      * [IDs](#identifiers)
      * [Entities](#entities)
      * [Provenance Metadata](#provenance-metadata)
   * [Use cases](#use-cases)
   * [FAQ](#faq)
   * [License](#license)
      
# Overview 

W3C defines provenance as:

> Provenance is information about entities, activities, and people involved in producing
> a piece of data or thing, which can be used to form assessments 
> about its quality, reliability or trustworthiness. [source](https://www.w3.org/TR/prov-overview/#Abstract)

Readers may wish to refer to a longer introduction about the W3C Provenance standard [here](https://www.w3.org/TR/2013/NOTE-prov-primer-20130430/#intuitive-overview-of-prov).

Data assets could be

* Published by a person or organization
* Comprised of information about a person or set of persons (e.g. a data asset of medical study with data on subjects)
* Revised or updated by a different person or organization
* Merged by joining one or more data assets 
* Generated by a process that takes one or more data assets as inputs (e.g. training a model on 2 data assets) and produces a new data asset.

Provenance records information about the Actors (e.g. people), Activities (e.g. data cleaning, model training), Entities (data assets, algorithms) and the interactions between them. 

A database of provenance metadata can help answer questions such as:

* Who was involved in creating a data asset
* When did this data asset last change
* What were the inputs to the process that generated this data asset.
* Which versions of a data asset were used to train a specific model version

## W3C Provenance

Provenance (as defined by the W3C Provenance standard) can be modeled as a graph consisting nodes and connections between the nodes. The nodes in the graph are:

### Entities 

> In PROV, physical, digital, conceptual, or other kinds of thing are called entities. 
> Examples of such entities are a web page, a chart, and a spellchecker. [source](https://www.w3.org/TR/2013/NOTE-prov-primer-20130430/#entities)


### Agents

> An agent takes a role in an activity such that the agent can be assigned 
> some degree of responsibility for the activity taking place. An agent can be a person, 
> a piece of software, an inanimate object, an organization, or other entities 
> that may be ascribed responsibility. [source](https://www.w3.org/TR/2013/NOTE-prov-primer-20130430/#agents-and-responsibility)

### Activities

> Activities are how entities come into existence and how their attributes change to 
> become new entities, often making use of previously existing entities to achieve this. 
> They are dynamic aspects of the world, such as actions, processes, etc.
> For example, if the second version of document D was generated by a translation from 
> the first version of the document in another language, then this translation is an activity. [source](https://www.w3.org/TR/2013/NOTE-prov-primer-20130430/#activities-1)


![relationships between nodes](https://www.w3.org/TR/2013/NOTE-prov-primer-20130430/images/key-concepts.png)

Some of the connections/relationships between the nodes are:

* Entity-Activity interactions 
  - Activities generate new Entities  (wasGeneratedBy)
    - Example: A Data asset was generated by the publishing activity
  - Activities make use of Entities.  (used)
    - Example: A model training Activity used a training data asset Entity
  
* Agent-Activity interactions
  - Agents are associated with Activities (wasAssociatedWith)
    - Example: A user was associated with a publishing Activity
  
* Entity-Entity interactions
  - Entities can be derived from other Entities. (wasDerivedFrom)
    - Example: A cleaned data asset was derived from a raw data asset.
  
* An Activity can be started or finished at a particular time.


## Provenance for Entities and their interactions 

In the context of the data ecosystem,

* Data Assets and Algorithms are Entities. 
* Publishers, Consumers and Service Providers are Agents.
* Publishing and invoking Operations are Activities. 

Comparing a colloquial statement with the canonical Provenance definition:

| Colloquial                                          | Provenance Description                                                                                                                                                                                                  |
|-----------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| User Bob registered a data asset                 | (Agent) Bob was associated with a publishing activity, which generated a (Entity) data asset                                                                                                                            |
| Bob invoked a Consent operation to filter a data asset | (Agent) Bob was associated with a filtering activity, which *used* an (Entity) data asset and  generated a new (Entity) data asset. The consent service (Entity) was involved in (associated with) generating the asset |
|                                                     |                                                                                                                                                                                                                         |

## Motivation and Use cases

Provenance information can be read from three perspectives:

* Agent centered : People or organizations were involved in generating or manipulating the data assets
* Object centered : The origins of (portions of) a data asset from other data assets
* Process centered: Capturing the actions and steps taken to generate the data asset.

Use cases:

- Finding derivatives of a data asset
  -  e.g an model training algorithm (an Entity in Prov) has been involved in generating several assets (e.g. trained models). Let's assume that a data scientist found a bug in the algorithm and fixed it. Provenance metadata can help us find the data assets generated by this algorithm, which need to be updated.
  - The publisher of a data asset A1 (Entity in prov) requires that all data assets that used A1, must pay licensing fees as a percentage of their selling price. Provenance metadata can help us find all the data assets that used data asset A1.
- Reproducibility
  - According to a 2016 survey by Nature magazine, many scientific fields are facing a reproducibility [crisis](https://www.nature.com/news/1-500-scientists-lift-the-lid-on-reproducibility-1.19970), and this is particularly relevant to data science. Provenance infomation added to data pipelines can enable reproducibility of data assets generated by these pipelines.
  
  
![Provenance generated by operations](https://user-images.githubusercontent.com/89076/56648463-f9593e80-66b5-11e9-8bda-47a71cafdfa1.png)

# Definitions 

This section is normative
Provenance information is serialized in PROV-JSON, which is a JSON representation of the PROV data model. 
Provenance metadata must be compatible with W3C Prov. However, it may have additional constraints outlined below.

## Identifiers

#### Assets

Prov metadata must identify assets by the asset DID.

#### Agents 

Prov metadata must identify agents based on category:
- Service providers such as Storage service provider, with the DID
- Consumers must be identified by specifying
  - The account associated with the Agent.
  - If the user has a DID, s/he is encouraged to use the DID as the identifier. 

#### Activities

Activities can be categorized into two types:

- Invoke operations are activities, and they can be identified by their asset (operation) ID or DID.
- Manual activities (e.g. data cleaning) will benefit by having an ID. However, it is not mandatory for manual activities to have an ID.
 
## Entities

Agents with underlying implementations (e.g. an OceanProtocol Agents) must use *prov:type* for entities, activities and agents. The Agent must use a namespace prefix that corresponds to namespace [IRIs](https://dvcs.w3.org/hg/rdf/raw-file/default/rdf-concepts/index.html#dfn-namespace-iri). For example, Ocean Protocol uses the `opf` and `prov` namespace prefixes. The standard recommends that it is `common to abbreviate IRIs that start with namespace IRIs by using a namespace prefix in order to assist readability`.

This DEP recommends the use of the following values for *prov:type* depending on the type of entity. The rest of this document assumes that `ns` refers to a namespaces prefix defined by the agent. 

* Entities:
  - `ns:asset` : A data asset .
  - `ns:this`: A special attribute value that refers to the Entity being published or generated. 
  
* Activities:

  - `ns:publish` : The act of publishing a data asset.
  - `ns:import` : The act of importing a data asset which is defined in an existing data catalog. `Import` is used to distinguish from `publish` to indicate that prior provenance metadata associated with the data asset will be incorporated.
  - `ns:invoke` : The act of invoking an operation.

* Agents:

  - `ns:did` : DID of an Agent, if available.
  - `ns:address`: The address of the consumer.
  - `ns:id_type` : The type of the agent id, could be `ethereum_account` or `did`


## Provenance Metadata Sections 

Recall that the asset metadata is a JSON object, which is an unordered set of name/value pairs. Provenance metadata is represented as a name/value pair in the asset metadata object, where the **name** must be `provenance`. 
Note that provenance information is optional. However, if the **name** `provenance`exists, the value against that name must be a JSON object with valid provenance metadata, as described in the rest of this document.

The JSON Object representing provenance information consists of the following properties (this section is taken from the prov-json Overview)

```
{
    "entity": { // Map of entities by entities' IDs
    },
    "activity": { // Map of activities by IDs
    },
    "agent": { // Map of agents by IDs
    },
    <relationName>: { // A map of relations of type relationName by their IDs
    }
    }
}
```

Each property is itself a JSON Object. 
This DEP recommends that the provenance object must contain the following properties:

- **Entity** Data asset being published
- **Activity** Activity must be one of publish, import, or operation 
- **Agent** Agent (the ID of the person, organization or software) that published the data asset

Additionally, the DEP recommends that the following **relations** should be declared:

- **wasGeneratedBy** relation which associates the entity with the activity that generated it
- **wasAssociatedWith** relation with links the entity with the agent that published it 
- **wasDerivedFrom** relation which associates the input entities with the generated entities


### Entity

**Entity** is a JSON object consisting of name/value pairs. This object must contain references to all ocean assets involved in the activity (described in the activity section). 

- The **name** must be valid asset DIDs.
- The json object against each **name** must  contain the type property, where types can be one of the supported ocean asset types (e.g. asset, bundle or operation)
- The **name** `ns:this` has a special meaning, indicating that it refers to the asset currently being registered, hence it refers to itself.

Example of an entity declaration:
```
{
	"entity": {
		"ns:this": {
			"prov:type": {
				"$": "ns:asset",
				"type": "prov:string"
			}
		},

		"ns:did:26cb1a92e8a6b52e47e6e13d04221e9b005f70019e21c4586dad3810d46220135/26cb1a92e8a6b52e47e6e13d04221e9b005f70019e21c4586dad3810d462201a6": {
			"prov:type": {
				"$": "ns:asset",
				"type": "prov:string"
			}
		}
	}
}
```


### Activity 

This DEP supports three types of activities:

- Publishing a data asset
- Importing a data asset present in a different data catalog system, which has provenance information already associated with it.
- Registering a new asset which was created as a result of running an invoke operation.

Each activity addresses a different use case, and therefore impacts the provenance metadata.

-  Publishing
   - The `ns:this` property must be present in the *entity* JSON object.
 
- Importing
   - The `ns:this` property must be present in the *entity* JSON object.
  
- Invoking an operation
   - The `ns:this` property must be present in the *entity* JSON object.
   - A list of entities that were consumed by this operation must be listed in the inputs.
  
  
#### Properties of activity
Activities must declare

- An identifier, which must be a qualified name as defined by Provenance Data model. 
- A `prov:type` property, indicating the type of the activity, as described above.
- If the `prov:type` is `operation`, it must contain `ns:params` and `ns:results` properties. These are the inputs to, and output from, the invoke operation.

It is recommended that activities declare

-  Start and endtime properties

Example of an activity:
```
{
"activity": {
    "ns:617c906f-4f29-49d7-a111-ab0ff2bb0d45": {
      "prov:type": {
        "$": "ns:operation",
        "type": "xsd:string"
      },
      "prov:endTime": "2019-05-22T10:13:04.779+08:00",
      "ns:results": {
        "$": "{\"results\":{\"hashval\": {\"did\":\"a6cb1a92e8a6b52e47e6e13d04221e9b005f70019e21c4586dad3810d46220135\"}}}",
        "type": "xsd:string"
      },
      "ns:params": {
        "$": "{\"params\":{\"to-hash\": {\"did\":\"26cb1a92e8a6b52e47e6e13d04221e9b005f70019e21c4586dad3810d46220135\"}}}",
        "type": "xsd:string"
      }
    }
}
```

### Agent

The agent is the service provider responsible for running the activity. 

- If the activity is invoking an operation, the agent's DID must be declared.
- If it is a publisher, the publisher's account must be declared.
```
{
 "agent": {
    "ns:503a7b959f91ac691a0881ee724635427ea5f3862aa105040e30a0fee50cc1a00": {
      "prov:type": {
        "$": "ns:ethereum-account",
        "type": "xsd:string"
      }
    }
  }
}
```

### Relations

This DEP recommends that the following attributes should be used. Other attributes defined in the prov standard (e.g. usedBy or wasAttributedTo) can be used as well.
Each attribute object must include an identifier (e.g. "_:wbg4_", which includes an optional prefix as well as a local part)

Generation attribute (The Entity that was generated by the activity). It must specify the attributes

- `prov:entity`: The identifier of the entity that was generated, identified by `ns:this`
- `prov:activity` : The identifier of the activity (e.g. invoking an operation) that generated the entity

Example:
```
{
  "wasGeneratedBy": {
    "_:wGB1": {
      "prov:entity": "ns:this",
      "prov:activity": "ns:617c906f-4f29-49d7-a111-ab0ff2bb0d45"
    }
  }
}
```

Association attribute (the agent involved in the activity). It must specify

- `prov:agent`: The identifier of the agent
- `prov:activity` : The identifier of the activity

Example:
```
{
  "wasAssociatedWith": {
    "_:wAW1": {
      "prov:agent": "ns:503a7b959f91ac691a0881ee724635427ea5f3862aa105040e30a0fee50cc1a00",
      "prov:activity": "ns:617c906f-4f29-49d7-a111-ab0ff2bb0d45"
    }
  }
}
```

Derivedby attribute (The source Entity from which the new Entity was derived). This section must specify:

- `prov:generatedEntity` : The entity that was generated. Usually `ns:this`.
- `prov:usedEntity`: The identifier of the entity that was used as an input to the activity. If multiple entities were consumed, each one must be defined as a separate property. 
- This attribute is not mandatory for publish or import operations.


Example:
```
"wasDerivedFrom": {
    "_:wDF2": {
      "prov:generatedEntity": "ns:this",
      "prov:usedEntity": "ns:c98edc33b01c32b2d655fe0c5689fe6e5c0f71193796d3d0be035c58b1c6dfde"
    }
}
```

# Use cases

### Usecase 1: Publishing use case 

It is recommended that the publisher includes Prov metadata when an asset is published.

It must include:

- The Agent involved, which is identified using the ethereum account
- The Activity with type `publish`
- The Entity (data asset) that was published
- Generation relation 
  - Identify the Entity generated by the publishing activity 

### Usecase 2: Importing data asset usecase

When a user imports a data asset, the suggested provenance is similar to the publishing use case, with the exception that:

- The _type_ of the activity must be `ns:import`.

### Usecase 3: A service generating a new asset from existing assets

Invoke operations such as data cleaning, model training and others, generate new data assets. This process could have the following characteristics

- It may use one or more data assets or algorithms as input  (e.g a trained model would need an algorithm, and a training set as inputs)
- It may generate one of more data assets or algorithms as output (e.g. a trained model, and predictions from the model, could be the output of the activity)


The provenance metadata must include:

- Agents:
  - The Agent (software implementation that runs the operation) that runs the Operation 
  - The consumer that invoked the operation

- Entities:
  - A list of of inputs to this activity. It could contains a list of data assets and algorithms.
  - A list of outputs generated by this activity, referred to as `this` identifier. If multiple outputs are generated, each one is registered as a separate asset. 
  
- Activity: 
  - The operation that was invoked (e.g model training)
  - The input params and output (results) sent and received from the Invoke REST Endpoint.
  
It must specify the following relations:

- Generation (wasGeneratedBy)
- Derivation (wasDerivedBy):
  - The source Entities from which the new Entity was derived
- Association (wasAssociatedWith)
  - The agent(s) associated with the activity.
  
# FAQ

1. Which entity generates the provenance metadata?
  - When a operation generates an asset, the service provider must create valid provenance metadata.
  - When a user creates a derived data asset (e.g by cleaning a raw data asset), it is recommended that they use Starfish utilities to add provenance metadata.
 
# License

Copyright (c) 2019 DEX Pte. Ltd.

This DEP is free software; you can redistribute it and/or modify it under the terms of the Apache 2.0 License
 
